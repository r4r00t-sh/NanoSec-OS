#!/bin/sh
#
# NanoSec OS Init Script
# =======================
# PID 1 - First process to run on boot
#

# Mount essential filesystems
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
mount -t tmpfs none /tmp
mount -t tmpfs none /var/run

# Create necessary device nodes
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts

mknod -m 622 /dev/console c 5 1 2>/dev/null
mknod -m 666 /dev/null c 1 3 2>/dev/null
mknod -m 666 /dev/zero c 1 5 2>/dev/null
mknod -m 666 /dev/ptmx c 5 2 2>/dev/null
mknod -m 666 /dev/tty c 5 0 2>/dev/null
mknod -m 444 /dev/random c 1 8 2>/dev/null
mknod -m 444 /dev/urandom c 1 9 2>/dev/null

# Create log directories
mkdir -p /var/log/nanosec
mkdir -p /var/lib/nanosec/fim
mkdir -p /var/lib/nanosec/ids

# Set hostname
hostname nanosec

# Configure network (if available)
if [ -e /sys/class/net/eth0 ]; then
    ip link set eth0 up
    # DHCP would go here, or static IP
fi

# Display boot banner
clear
cat << 'BANNER'

    ███╗   ██╗ █████╗ ███╗   ██╗ ██████╗ ███████╗███████╗ ██████╗
    ████╗  ██║██╔══██╗████╗  ██║██╔═══██╗██╔════╝██╔════╝██╔════╝
    ██╔██╗ ██║███████║██╔██╗ ██║██║   ██║███████╗█████╗  ██║     
    ██║╚██╗██║██╔══██║██║╚██╗██║██║   ██║╚════██║██╔══╝  ██║     
    ██║ ╚████║██║  ██║██║ ╚████║╚██████╔╝███████║███████╗╚██████╗
    ╚═╝  ╚═══╝╚═╝  ╚═╝╚═╝  ╚═══╝ ╚═════╝ ╚══════╝╚══════╝ ╚═════╝
                                                                  
                   Security-First Linux OS v1.0
                   
BANNER

echo "Initializing security services..."
echo ""

# Start firewall
echo -n "[1/3] Firewall: "
if [ -x /opt/nanosec/security/firewall/nfw.sh ]; then
    /opt/nanosec/security/firewall/nfw.sh start >/dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "ACTIVE"
    else
        echo "FAILED (run 'nfw start' manually)"
    fi
else
    echo "NOT INSTALLED"
fi

# Start IDS
echo -n "[2/3] IDS:      "
if [ -x /usr/bin/python3 ] && [ -f /opt/nanosec/security/ids/ids.py ]; then
    python3 /opt/nanosec/security/ids/ids.py --daemon >/dev/null 2>&1 &
    sleep 1
    if pgrep -f "ids.py" >/dev/null; then
        echo "RUNNING"
    else
        echo "FAILED (run 'ids --daemon' manually)"
    fi
else
    echo "NOT INSTALLED"
fi

# Check FIM baseline
echo -n "[3/3] FIM:      "
if [ -f /var/lib/nanosec/fim/baseline.json ]; then
    echo "BASELINE LOADED"
else
    echo "NO BASELINE (run 'fim --baseline /etc')"
fi

echo ""
echo "═══════════════════════════════════════════════════════════"
echo "  System ready. Type 'help' for available commands."
echo "═══════════════════════════════════════════════════════════"
echo ""

# Start NASH shell
if [ -x /usr/bin/python3 ] && [ -f /opt/nanosec/nash/nash.py ]; then
    exec python3 /opt/nanosec/nash/nash.py
else
    # Fallback to BusyBox ash
    echo "NASH not available, falling back to sh"
    exec /bin/sh
fi
